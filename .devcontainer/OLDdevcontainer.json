{
  "name": "DegenZ Lounge - Full Stack Dev+Prod",
  "dockerComposeFile": ["docker-compose.yml", "docker-compose.override.yml"],
  "service": "app",
  "workspaceFolder": "/workspace",
  "shutdownAction": "stopCompose",
  "remoteUser": "node",

  // Environment variables (dev defaults)
  "containerEnv": {
    "NODE_ENV": "development",
    "TZ": "UTC",
    "DEBUG": "degenez:*",
    "NEXT_TELEMETRY_DISABLED": "1"
  },

  // Production overrides (when using --profile production)
  "overrideCommand": true,
  "initializeCommand": "if [ -f /workspace/.devcontainer/prod-init.sh ]; then bash /workspace/.devcontainer/prod-init.sh; fi",

  // Features for full-stack development
  "features": {
    "ghcr.io/devcontainers/features/node:1": {
      "version": "18",
      "packageManager": "npm"
    },
    "ghcr.io/devcontainers/features/github-cli:1": {},
    "ghcr.io/devcontainers-contrib/features/prisma:2": {
      "version": "latest"
    },
    "ghcr.io/devcontainers/features/sshd:1": {
      "version": "latest",
      "startServer": true
    },
    "ghcr.io/devcontainers/features/docker-in-docker:2": {
      "version": "latest",
      "moby": true
    },
    "ghcr.io/devcontainers/features/azure-cli:1": {}
  },

  // Port forwarding
  "forwardPorts": [
    3000,  // Next.js
    5555,  // Prisma Studio
    9229,  // Node debug
    5432,  // PostgreSQL
    9090   // Optional metrics
  ],

  // VS Code extensions
  "extensions": [
    "dbaeumer.vscode-eslint",
    "esbenp.prettier-vscode",
    "prisma.prisma",
    "bradlc.vscode-tailwindcss",
    "GitHub.copilot",
    "ms-azuretools.vscode-docker",
    "graphql.vscode-graphql",
    "eamodio.gitlens",
    "wix.vscode-import-cost",
    "usernamehw.errorlens"
  ],

  // Workspace settings
  "settings": {
    "editor.defaultFormatter": "esbenp.prettier-vscode",
    "editor.formatOnSave": true,
    "editor.codeActionsOnSave": {
      "source.fixAll.eslint": true,
      "source.organizeImports": true
    },
    "typescript.tsdk": "node_modules/typescript/lib",
    "eslint.packageManager": "npm",
    "javascript.updateImportsOnFileMove.enabled": "always",
    "typescript.updateImportsOnFileMove.enabled": "always",
    "docker.showStartPage": false,
    "terminal.integrated.defaultProfile.linux": "bash"
  },

  // Post-create commands
  "postCreateCommand": "npm ci && npx prisma generate && npm run build",

  // Customizations
  "customizations": {
    "codespaces": {
      "openFiles": ["README.md", "prisma/schema.prisma"],
      "dotfiles": {
        "upstreamRepo": "https://github.com/KarmaENT/dotfiles.git",
        "installCommand": "bash install.sh"
      }
    },
    "vscode": {
      "settings": {
        "workbench.startupEditor": "none",
        "security.workspace.trust.untrustedFiles": "open"
      }
    }
  },

  // Remote environment variables (secrets should be in Codespaces secrets)
  "remoteEnv": {
    "DATABASE_URL": "postgresql://postgres:postgres@db:5432/degenez-dev?schema=public",
    "NEXTAUTH_URL": "http://localhost:3000",
    "NEXTAUTH_SECRET": "${localEnv:NEXTAUTH_SECRET}",
    "GITHUB_CLIENT_ID": "${localEnv:GITHUB_CLIENT_ID}",
    "GITHUB_CLIENT_SECRET": "${localEnv:GITHUB_CLIENT_SECRET}",
    "DISCORD_CLIENT_ID": "${localEnv:DISCORD_CLIENT_ID}",
    "DISCORD_CLIENT_SECRET": "${localEnv:DISCORD_CLIENT_SECRET}"
  },

  // Host requirements
  "hostRequirements": {
    "cpus": 4,
    "memory": "8gb",
    "storage": "32gb"
  }
}
# Production image - Ubuntu for stability
FROM node:18-bullseye AS builder

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    openssl \
    && rm -rf /var/lib/apt/lists/*

# Install dependencies
COPY package.json package-lock.json* ./
RUN npm ci --omit=dev

# Copy and build application
COPY . .
RUN npm run build

# Final production image
FROM ubuntu:22.04

WORKDIR /app

# Install runtime dependencies
RUN apt-get update && apt-get install -y \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Copy built assets from builder
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/public ./public
COPY --from=builder /app/package.json .
COPY --from=builder /app/prisma ./prisma

# Install Prisma engine
RUN apt-get update && apt-get install -y \
    openssl \
    && rm -rf /var/lib/apt/lists/*

# Environment setup
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1

# Security hardening
RUN groupadd -r node && useradd -r -g node node \
    && chown -R node:node /app

USER node

EXPOSE 3000
CMD ["npm", "start"]

